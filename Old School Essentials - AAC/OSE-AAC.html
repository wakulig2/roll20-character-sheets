<input type="hidden" name="attr_BonusSTR" value="0" />
<input type="hidden" name="attr_BonusDEX" value="0" />
<input type="hidden" name="attr_ArmorBenefitTotal" value="0" />
<input type="hidden" name="attr_ArmorWeightTotal" value="0" />
<input type="hidden" name="attr_ItemWeightTotal" value="0" />
<input type="hidden" name="attr_WeaponWeightTotal" value="0" />
<input type="hidden" name="attr_sheetTab" value="character" class="sheet-tabsToggle" />

<div class="sheet-button-select">
  <button type="action" name="act_character" data-i18n="character">Character</button>
  <button type="action" name="act_monster" data-i18n="monster">Monster</button>
</div>

<div class="sheet-character">
  <div class="info-grid">
    <div class="logo">
      <img src="https://i84.servimg.com/u/f84/13/24/51/43/logone12.png" />
    </div>
    <div class="infos">
      <div class="flex">
        <label class="inline-flex">
          <span data-i18n="name-pc-abbr">PC</span>
          <input type="text" name="attr_character_name" data-i18n-placeholder="character-name"
            placeholder="Character name" />
        </label>
        <label class="inline-flex">
          <span data-i18n="alignment-abbr">AL</span>
          <input type="text" name="attr_alignment" data-i18n-placeholder="alignment" placeholder="Alignment" />
        </label>
      </div>
      <div class="flex">
        <label class="inline-flex">
          <span data-i18n="class">Class</span>
          <input type="text" name="attr_class" data-i18n-placeholder="class" placeholder="Class" />
        </label>
        <label class="inline-flex">
          <span data-i18n="level">Level</span>
          <input type="number" name="attr_level" value="1" />
        </label>
        <label class="inline-flex">
          <span data-i18n="title">Title</span>
          <input type="text" name="attr_title" data-i18n-placeholder="title" placeholder="Title" />
        </label>
      </div>
      <div class="flex">
        <label class="inline-flex">
          <span data-i18n="experience-abbr">XP</span>
          <input type="number" name="attr_XP" value="0" />
        </label>
        <label class="inline-flex">
          <span data-i18n="next">Next</span>
          <input type="number" name="attr_Next" data-i18n-title="experience-next" title="Experience to Next Level"
            value="0" />
        </label>
        <label class="inline-flex">
          <span>+%</span>
          <input type="number" name="attr_ExpPercentage" value="0" />
        </label>
        <label class="inline-flex">
          <span data-i18n="hit-dice-abbr">HD</span>
          <input readonly type="number" name="attr_hitdice" value="0" />
        </label>
        <label class="inline-flex">
          <span>Â±</span>
          <input type="number" name="attr_HPMod" value="0" title="HP Modifier" data-i18n-title="hitdice-modifier" />
        </label>
      </div>
    </div>
  </div>

  <div>
    <h1 data-i18n="ability-scores">Ability Scores</h1>
    <div class="scores roll flex">
      <label class="inline-flex inline-flex-wide-label">
        <button type="roll" name="attr_rollSTR"
          value="&{template:less} {{roll=^{strength}}} {{result=[[ [[1d20]]<@{str}+@{modquery} ]]}} {{check=[[@{str}+@{modquery}]]}}"
          data-i18n="strength-abbr">
          STR
        </button>
        <input type="number" name="attr_str" value="0" />
      </label>
      <label class="inline-flex inline-flex-wide-label">
        <button type="roll" name="attr_rollINT"
          value="&{template:less} {{roll=^{intelligence}}} {{result=[[ [[1d20]]<@{int}+@{modquery} ]]}} {{check=[[@{int}+@{modquery}]]}}"
          data-i18n="intelligence-abbr">
          INT
        </button>
        <input type="number" name="attr_int" value="0" />
      </label>
      <label class="inline-flex inline-flex-wide-label">
        <button type="roll" name="attr_rollWIS"
          value="&{template:less} {{roll=^{wisdom}}} {{result=[[ [[1d20]]<@{wis}+@{modquery} ]]}} {{check=[[@{wis}+@{modquery}]]}}"
          data-i18n="wisdom-abbr">
          WIS
        </button>
        <input type="number" name="attr_wis" value="0" />
      </label>
      <label class="inline-flex inline-flex-wide-label">
        <button type="roll" name="attr_rollDEX"
          value="&{template:less} {{roll=^{dexterity}}} {{result=[[ [[1d20]]<@{dex}+@{modquery} ]]}} {{check=[[@{dex}+@{modquery}]]}}"
          data-i18n="dexterity-abbr">
          DEX
        </button>
        <input type="number" name="attr_dex" value="0" />
      </label>
      <label class="inline-flex inline-flex-wide-label">
        <button type="roll" name="attr_rollCON"
          value="&{template:less} {{roll=^{constitution}}} {{result=[[ [[1d20]]<@{con}+@{modquery} ]]}} {{check=[[@{con}+@{modquery}]]}}"
          data-i18n="constitution-abbr">
          CON
        </button>
        <input type="number" name="attr_con" value="0" />
      </label>
      <label class="inline-flex inline-flex-wide-label">
        <button type="roll" name="attr_rollCHA"
          value="&{template:less} {{roll=^{charisma}}} {{result=[[ [[1d20]]<@{cha}+@{modquery} ]]}} {{check=[[@{cha}+@{modquery}]]}}"
          data-i18n="charisma-abbr">
          CHA
        </button>
        <input type="number" name="attr_cha" value="0" />
      </label>
    </div>
  </div>

  <div>
    <h1 data-i18n="exploration">Exploration</h1>
    <div class="exploration roll flex">
      <label class="inline-flex inline-flex-wide-label">
        <button type="roll" name="attr_rollListenDoor"
          value="&{template:less} {{roll=^{listen-at-door-full}}} {{result=[[ [[1d6]]<@{ListenDoor}+@{modquery} ]]}} {{check=[[@{ListenDoor}+@{modquery}]]}}"
          data-i18n="listen-at-door">
          Listen at door
        </button>
        <input type="number" name="attr_ListenDoor" value="1" />
      </label>
      <label class="inline-flex inline-flex-wide-label">
        <button type="roll" name="attr_rollOpenDoor"
          value="&{template:less} {{roll=^{open-stuck-door-full}}} {{result=[[ [[1d6]]<@{OpenDoor}+@{modquery} ]]}} {{check=[[@{OpenDoor}+@{modquery}]]}}"
          data-i18n="open-stuck-door">
          Open stuck door
        </button>
        <input type="number" name="attr_OpenDoor" value="1" />
      </label>
      <label class="inline-flex inline-flex-wide-label">
        <button type="roll" name="attr_rollFindSecretDoor"
          value="&{template:less} {{roll=^{find-secret-door-full}}} {{result=[[ [[1d6]]<@{FindSecretDoor}+@{modquery} ]]}} {{check=[[@{FindSecretDoor}+@{modquery}]]}}"
          data-i18n="find-secret-door">
          Find secret door
        </button>
        <input type="number" name="attr_FindSecretDoor" value="1" />
      </label>
      <label class="inline-flex inline-flex-wide-label">
        <button type="roll" name="attr_rollFindRoomTrap"
          value="&{template:less} {{roll=^{find-room-trap-full}}} {{result=[[ [[1d6]]<@{FindRoomTrap}+@{modquery} ]]}} {{check=[[@{FindRoomTrap}+@{modquery}]]}}"
          data-i18n="find-room-trap">
          Find room trap
        </button>
        <input type="number" name="attr_FindRoomTrap" value="1" />
      </label>
    </div>
  </div>

  <div class="sheet-saves">
    <h1 data-i18n="saving-throws">Saving Throws</h1>
    <div class="saving roll flex">
      <label class="inline-flex inline-flex-wide-label">
        <button type="roll" name="attr_rollSaving-1"
          value="&{template:greater} {{roll=^{death-poison-full}}} {{result=[[ [[1d20]]>@{Saving-1}+@{modquery} ]]}} {{check=[[@{Saving-1}+@{modquery}]]}}"
          data-i18n="death-poison">
          Death, Poison
        </button>
        <input type="number" name="attr_Saving-1" value="0" />
      </label>

      <label class="inline-flex inline-flex-wide-label">
        <button type="roll" name="attr_rollSaving-2"
          value="&{template:greater} {{roll=^{magic-wands-full}}} {{result=[[ [[1d20]]>@{Saving-2}+@{modquery} ]]}} {{check=[[@{Saving-2}+@{modquery}]]}}"
          data-i18n="magic-wands">
          Magic wands
        </button>
        <input type="number" name="attr_Saving-2" value="0" />
      </label>

      <label class="inline-flex inline-flex-wide-label">
        <button type="roll" name="attr_rollSaving-3"
          value="&{template:greater} {{roll=^{paralysis-petrification-full}}} {{result=[[ [[1d20]]>@{Saving-3}+@{modquery} ]]}} {{check=[[@{Saving-3}+@{modquery}]]}}"
          data-i18n="paralysis-petrification">
          Paralysis, Petrification
        </button>
        <input type="number" name="attr_Saving-3" value="0" />
      </label>

      <label class="inline-flex inline-flex-wide-label">
        <button type="roll" name="attr_rollSaving-4"
          value="&{template:greater} {{roll=^{breath-attacks-full}}} {{result=[[ [[1d20]]>@{Saving-4}+@{modquery} ]]}} {{check=[[@{Saving-4}+@{modquery}]]}}"
          data-i18n="breath-attacks">
          Breath attacks
        </button>
        <input type="number" name="attr_Saving-4" value="0" />
      </label>
      <label class="inline-flex inline-flex-wide-label">
        <button type="roll" name="attr_rollSaving-5"
          value="&{template:greater} {{roll=^{spells-rods-staves-full}}} {{result=[[ [[1d20]]>@{Saving-5}+@{modquery} ]]}} {{check=[[@{Saving-5}+@{modquery}]]}}"
          data-i18n="spells-rods-staves">
          Spells, Rods, Staves
        </button>
        <input type="number" name="attr_Saving-5" value="0" />
      </label>
    </div>
  </div>

  <div class="sheet-abilities sheet-repeat">
    <h1 data-i18n="abilities-and-skills">Abilities & Skills</h1>
    <div class="abilities-grid">
      <span></span>
      <span data-i18n="name">Name</span>
      <span data-i18n="roll">Roll</span>
      <span data-i18n="abbr-versus">vs</span>
      <span data-i18n="threshold">Threshold</span>
      <span data-i18n="description">Description</span>
    </div>
    <fieldset class="repeating_abilities">
      <div class="abilities-grid">
        <button type="roll" name="abilityRoll"
          value="&{template:skill} {{name=@{}}} {{symbol=[[@{abilityDirection}]]}} {{roll=@{abilityName}}} {{result=[[@{abilityRoll}]]}} {{check=[[0+@{abilityThreshold}]]}} {{description=@{abilityDescription}}}"></button>
        <input type="text" name="attr_abilityName" placeholder="Name" data-i18n="name" />
        <input type="text" class="half-input" name="attr_abilityRoll" placeholder="2d6" />
        <select name="attr_abilityDirection" class="half-input">
          <option value="0"></option>
          <option value="1">&lt;</option>
          <option value="2">&gt;</option>
        </select>
        <input type="number" name="attr_abilityThreshold" placeholder="7" />
        <input type="text" name="attr_abilityDescription" data-i18n-placeholder="description"
          placeholder="Description" />
      </div>
    </fieldset>
  </div>

  <div>
    <input type="hidden" name="attr_armor_class_method" value="aac" />
    <h1 data-i18n="combat">Combat</h1>
    <div class="roll combat">
      <div>
        <div class="flex hp">
          <label class="inline-flex">
            <span data-i18n="hit-points-abbr">HP</span>
            <input type="number" name="attr_HP" value="0" />
          </label>
          <label class="inline-flex">
            <span data-i18n="max">Max</span>
            <input type="number" name="attr_HP_max" value="0" />
          </label>
          <label class="inline-flex">
            <span data-i18n="constitution-abbr-mod">Â± CON</span>
            <input readonly type="number" name="attr_HPConMod" value="0" />
          </label>
        </div>
        <div class="flex hp">
          <label class="inline-flex">
            <span data-i18n="armor-class-abbr" title="Armor Class" data-i18n-title="armor-class">AC</span>
            <input readonly type="number" name="attr_ac" value="0" />
          </label>
          <label class="inline-flex">
            <span data-i18n="unarmored" class="double">Unarmored</span>
            <input readonly type="number" name="attr_acUnarmored" />
          </label>
          <label class="inline-flex">
            <span data-i18n="dexterity-abbr-mod">Â± DEX</span>
            <input readonly type="number" name="attr_ACDexMod" value="0" />
          </label>
        </div>
      </div>
      <div class="sheet-col movement">
        <table>
          <caption data-i18n="movement">Movement</caption>
          <thead>
            <tr>
              <th data-i18n="movement-en">Encounter</th>
              <th data-i18n="movement-ex">Exploration</th>
              <th data-i18n="movement-ov">Overland</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>
                <input disabled type="number" name="attr_movementEncounter" data-i18n-title="movement-encounter"
                  title="Movement - Encounter" value="floor(@{movementExploration}/4)" />
              </td>
              <td>
                <input type="number" name="attr_movementExploration" data-i18n-title="movement-exploration"
                  title="Movement - Exploration" value="120" />
              </td>
              <td>
                <input disabled type="number" name="attr_movementOverland" data-i18n-title="movement-overland"
                  title="Movement - Overland" value="floor(@{movementExploration}/5)" />
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="sheet-col initiative">
        <label class="inline-flex">
          <button type="roll" name="attr_rollInit"
            value="&{template:simple} {{roll=^{initiative}}} {{result=[[1d6 &{tracker}]]}}" data-i18n="initiative-init">
            Init.
          </button>
          <input type="number" name="attr_initiative" value="0" />
        </label>
        <label class="inline-flex">
          <span data-i18n="dexterity-abbr-mod">Â± DEX</span>
          <input readonly type="number" name="attr_InitDexMod" value="0" />
        </label>
      </div>
    </div>
  </div>

  <div class="sheet-weapons sheet-repeat">
    <h1 data-i18n="weapons">Weapons</h1>
    <div class="weapons-grid">
      <span></span>
      <span data-i18n="name">Name</span>
      <span data-i18n="attribute">Attribute</span>
      <span data-i18n="attack-modifier">+Attack</span>
      <span data-i18n="damage-die">Damage Die</span>
      <span data-i18n="damage-modifier">+Damage</span>
      <span data-i18n="weight">Weight</span>
    </div>
    <fieldset class="repeating_weapons">
      <div class="weapons-grid">
        <button type="roll" name="attr_weaponAttack"
          value="&{template:simple} {{roll=Attack with @{weaponName}}} {{attack=[[1d20+@{weaponAttributeBonus}+@{weaponAttackBonus}+@{modquery}]]}} {{damage=[[{[[@{weaponDamageDie}+@{weaponDamageBonus}+@{weaponAttributeBonus}]], 1}kh1]]}}"></button>
        <input type="text" name="attr_weaponName" placeholder="Weapon" />
        <select name="attr_weaponAttributeBonus">
          <option selected value="[[@{BonusSTR}]]">Strength</option>
          <option value="[[@{BonusDEX}]]">Dexterity</option>
        </select>
        <input type="number" name="attr_weaponAttackBonus" value="0">
        <select name="attr_weaponDamageDie" class="half-input">
          <option value="d4">d4</option>
          <option selected value="d6">d6</option>
          <option value="d8">d8</option>
          <option value="d10">d10</option>
          <option value="d12">d12</option>
        </select>
        <input type="number" name="attr_weaponDamageBonus" value="0" />
        <input type="number" name="attr_weaponWeight" placeholder="100">
      </div>
    </fieldset>
  </div>

  <div class="sheet-spells sheet-repeat">
    <h1>Spells</h1>
    <div class="spells-grid">
      <span></span>
      <span data-i18n="name">Name</span>
      <span data-i18n="duration">Duration</span>
      <span data-i18n="range">Range</span>
      <span data-i18n="description">Description</span>
      <span data-i18n="effect-roll">Effect Roll</span>
    </div>
    <fieldset class="repeating_spells">
      <div class="spells-grid">
        <button type="roll" name="spellRoll"
          value="&{template:simple} {{roll=Casts @{spellName}}} {{duration=@{spellDuration}}} {{range=@{spellRange}}} {{description=@{spellDescription}}} {{effect=[[@{spellEffect}]]}}"></button>
        <input type="text" name="attr_spellName" placeholder="Magic Missile"
          data-i18n-placeholder="spell-name-placeholder" />
        <input type="text" name="attr_spellDuration" placeholder="1 turn"
          data-i18n-placeholder="spell-duration-placeholder" />
        <input type="text" name="attr_spellRange" placeholder="150'" />
        <input type="text" name="attr_spellDescription"
          placeholder="This spell conjures a glowing dart of energy that the caster may choose to shoot at a visible target within range."
          data-i18n-placeholder="spell-description-placeholder" />
        <input type="text" class="half-input" name="attr_spellEffect" placeholder="1d6+1" />
      </div>
    </fieldset>
  </div>

  <div>
    <h1 data-i18n="items-equipment">Items & Equipment</h1>
    <div class="equip">
      <h2>Gear</h2>
      <div class="items-grid">
        <span data-i18n="quantity-abbr">Qty</span>
        <span data-i18n="name">Name</span>
        <span data-i18n="description">Description</span>
        <span data-i18n="weight">Weight</span>
      </div>
      <div class="sheet-items sheet-repeat">
        <fieldset class="repeating_items">
          <div class="items-grid">
            <input type="number" name="attr_ItemQuantity" value="1" />
            <input type="text" name="attr_ItemName" data-i18n-placeholder="name" placeholder="Name" />
            <input type="text" name="attr_ItemDescription" data-i18n-placeholder="description"
              placeholder="Description" />
            <input type="number" name="attr_ItemWeight" value="0" />
          </div>
        </fieldset>
      </div>
      <h2>Armor</h2>
      <div class="armor-grid">
        <span data-i18n="name">Name</span>
        <span data-i18n="armor-benefit">AC Benefit</span>
        <span data-i18n="armor-weight">Armor Weight</span>
        <span data-i18n="worn-question">Worn?</span>
      </div>
      <div class="sheet-armor sheet-repeat">
        <fieldset class="repeating_armor">
          <div class="armor-grid">
            <input type="text" name="attr_armorName" placeholder="Leather"
              data-i18n-placeholder="armor-name-placeholder" />
            <input type="text" name="attr_armorBenefit" placeholder="2" />
            <input type="number" name="attr_armorWeight" placeholder="200" />
            <div class="checkbox">
              <input type="checkbox" checked name="attr_armorWorn" />
            </div>
          </div>
        </fieldset>
      </div>
    </div>
    <h2>Coins</h2>
    <div class="coins flex">
      <label class="inline-flex">
        <span data-i18n="platinum-piece-abbr">PP</span>
        <input type="number" name="attr_PP" title="Platinum" data-i18n-placeholder="platinum-placeholder" value="0" />
      </label>
      <label class="inline-flex">
        <span data-i18n="gold-piece-abbr">GP</span>
        <input type="number" name="attr_GP" title="Gold" data-i18n-placeholder="gold-placeholder" value="0" />
      </label>
      <label class="inline-flex">
        <span data-i18n="electrum-piece-abbr">EP</span>
        <input type="number" name="attr_EP" title="Electrum" data-i18n-placeholder="electrum-placeholder" value="0" />
      </label>
      <label class="inline-flex">
        <span data-i18n="silver-piece-abbr">SP</span>
        <input type="number" name="attr_SP" title="Silver" data-i18n-placeholder="silver-placeholder" value="0" />
      </label>
      <label class="inline-flex">
        <span data-i18n="copper-piece-abbr">CP</span>
        <input type="number" name="attr_CP" title="Copper" data-i18n-placeholder="copper-placeholder" value="0" />
      </label>
      <label class="inline-flex inline-flex-wide-label" style="width: 150%">
        <span data-i18n="encumbrance">Encumbrance</span>
        <input readonly type="number" name="attr_encumbrance" value="0" />
      </label>
    </div>
  </div>
</div>

<div class="sheet-monster">
  <div class="flex roll">
    <label class="inline-flex">
      <span data-i18n="name">Name</span>
      <input type="text" name="attr_monsterName" />
    </label>
    <label class="inline-flex">
      <span class="double" data-i18n="description">Description</span>
      <input type="text" name="attr_monsterDescription" />
    </label>
    <label class="inline-flex">
      <span data-i18n="alignment-abbr">AL</span>
      <input type="text" name="attr_alignment" data-i18n-placeholder="alignment" placeholder="Alignment" />
    </label>
  </div>
  <div class="flex roll">
    <label class="inline-flex">
      <button type="roll"
        value="/w gm &{template:simple} {{roll=Number of @{monsterName} appearing}} {{wandering=[[@{numberAppearingWandering}]]}} {{lair=[[@{numberAppearingLair}]]}}">NA</button>
      <input type="text" class="input-as-number" name="attr_numberAppearingWandering" value="0" placeholder="1d4" />
      <input type="text" class="input-as-number" name="attr_numberAppearingLair" value="0" placeholder="2d4+2" />
    </label>
    <label class="inline-flex">
      <button type="roll"
        value="/w gm &{template:simple} {{roll=Morale of @{monsterName}}} {{morale=[[{2d6+0, 0d0+13}<@{monsterMorale}]]}}"
        title="Morale" data-i18n-title="morale" data-i18n="morale-abbr">ML</button>
      <input type="number" name="attr_monsterMorale" value="7" />
    </label>
    <label class="inline-flex">
      <span data-i18n="experience-abbr">XP</span>
      <input type="number" name="attr_monsterXPValue" />
    </label>
    <label class="inline-flex">
      <span data-i18n="treasure-type-abbr">TT</span>
      <input type="text" class="input-as-number" name="attr_monsterTreasureTypeGroup" />
      <input type="text" class="input-as-number" name="attr_monsterTreasureTypeIndividual" />
    </label>
  </div>

  <div>
    <input type="hidden" name="attr_armor_class_method" value="aac" />
    <h1 data-i18n="combat">Combat</h1>
    <div class="roll monster-combat">
      <div>
        <div class="flex hp">
          <label class="inline-flex">
            <button type="roll" data-i18n="hit-dice-abbr" title="Hit Dice" data-i18n-title="hit-dice"
              value="/w gm &{template:simple} {{roll=HP for @{monsterName}}} {{result=[[@{monsterHitDice}d8+@{monsterHitDiceModifier}]]}}">HD</button>
            <input type="number" name="attr_monsterHitDice" value="1" />
            <span>+</span>
            <input type="number" name="attr_monsterHitDiceModifier" value="0" />
          </label>
          <label class="inline-flex">
            <button type="action" name="act_setAverageHP" class="double" data-i18n="hit-points-average">Average
              HP</button>
            <input disabled type="number" name="attr_averageHP"
              value="floor(@{monsterHitDice}*4.5+@{monsterHitDiceModifier})" />
          </label>
          <label class="inline-flex">
            <span data-i18n="hit-points-abbr">HP</span>
            <input type="number" name="attr_HP" value="0" />
          </label>
          <label class="inline-flex">
            <span data-i18n="hit-points-max-abbr">Max</span>
            <input type="number" name="attr_HP_max" value="0" />
          </label>
        </div>
        <div class="flex">
          <label class="inline-flex">
            <span data-i18n="base-attack-bonus-abbr" title="Base Attack Bonus"
              data-i18n-title="Base Attack Bonus">BAB</span>
            <input type="number" name="attr_monsterBAB" value="0" />
          </label>
          <label class="inline-flex">
            <span data-i18n="armor-class-abbr" title="Armor Class" data-i18n-title="armor-class">AC</span>
            <input type="number" name="attr_monsterAc" value="0" />
          </label>
        </div>
      </div>
      <div class="sheet-col movement">
        <table>
          <caption data-i18n="movement">Movement</caption>
          <thead>
            <tr>
              <th data-i18n="movement-encounter">Encounter</th>
              <th data-i18n="movement-exploration">Exploration</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>
                <input disabled type="number" name="attr_movementEncounter" value="floor(@{movementExploration}/4)" />
              </td>
              <td>
                <input type="number" name="attr_movementExploration" value="120" />
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="sheet-weapons sheet-repeat">
    <h1 data-i18n="attacks">Attacks</h1>
    <div class="weapons-grid">
      <span></span>
      <span data-i18n="number-abbr" title="Number" data-i18n-title="number">#</span>
      <span data-i18n="name">Name</span>
      <span data-i18n="damage">Damage</span>
      <span data-i18n="description">Description</span>
    </div>
    <fieldset class="repeating_weapons">
      <div class="weapons-grid">
        <button type="roll" name="attr_weaponAttack"
          value="&{template:simple} {{roll=Attack with @{weaponName}}} {{attack=[[1d20+@{monsterBAB}+@{modquery}]]}} {{damage=[[{[[@{weaponDamageDie}]], 1}kh1]]}} {{description=@{weaponDescription}}"></button>
        <input type="number" name="attr_weaponAttacks" value="1">
        <input type="text" name="attr_weaponName" placeholder="Weapon" data-i18n-placeholder="weapon" />
        <input type="text" name="attr_weaponDamageDie" value="1d6+1" />
        <input type="text" name="attr_weaponDescription" value="" />
      </div>
    </fieldset>
  </div>

  <div class="sheet-abilities sheet-repeat">
    <h1 data-i18n="abilities-and-skills">Abilities & Skills</h1>
    <div class="abilities-grid">
      <span></span>
      <span data-i18n="name">Name</span>
      <span data-i18n="description">Description</span>
    </div>
    <fieldset class="repeating_abilities">
      <div class="abilities-grid">
        <button type="roll" name="abilityRoll"
          value="&{template:simple} {{roll=@{abilityName}}} {{description=@{abilityDescription}}}"></button>
        <input type="text" name="attr_abilityName" placeholder="Name" data-i18n-placeholder="name" />
        <input type="text" name="attr_abilityDescription" data-i18n-placeholder="description"
          placeholder="Description" />
      </div>
    </fieldset>
  </div>

  <div class="sheet-spells sheet-repeat">
    <h1 data-i18n="spells">Spells</h1>
    <div class="spells-grid">
      <span></span>
      <span data-i18n="name">Name</span>
      <span data-i18n="duration">Duration</span>
      <span data-i18n="range">Range</span>
      <span data-i18n="description">Description</span>
      <span data-i18n="effect-roll">Effect Roll</span>
    </div>
    <fieldset class="repeating_spells">
      <div class="spells-grid">
        <button type="roll" name="spellRoll"
          value="&{template:simple} {{roll=Casts @{spellName}}} {{duration=@{spellDuration}}} {{range=@{spellRange}}} {{description=@{spellDescription}}} {{effect=[[@{spellEffect}]]}}"></button>
        <input type="text" name="attr_spellName" placeholder="Magic Missile"
          data-i18n-placeholder="spell-name-placeholder" />
        <input type="text" name="attr_spellDuration" placeholder="1 turn"
          data-i18n-placeholder="spell-duration-placeholder" />
        <input type="text" name="attr_spellRange" placeholder="150'" />
        <input type="text" name="attr_spellDescription"
          placeholder="This spell conjures a glowing dart of energy that the caster may choose to shoot at a visible target within range."
          data-i18n-placeholder="spell-description-placeholder" />
        <input type="text" class="half-input" name="attr_spellEffect" placeholder="1d6+1" />
      </div>
    </fieldset>
  </div>

  <div class="sheet-saves">
    <h1 data-i18n="saving-throws">Saving Throws</h1>
    <div class="saving roll flex">
      <label class="inline-flex inline-flex-wide-label">
        <button type="roll" name="attr_rollSaving-1"
          value="&{template:greater} {{roll=^{death-poison-full}}} {{result=[[ [[1d20]]>@{Saving-1}+@{modquery} ]]}} {{check=[[@{Saving-1}+@{modquery}]]}}"
          data-i18n="death-poison">
          Death, Poison
        </button>
        <input type="number" name="attr_Saving-1" value="0" />
      </label>

      <label class="inline-flex inline-flex-wide-label">
        <button type="roll" name="attr_rollSaving-2"
          value="&{template:greater} {{roll=^{magic-wands-full}}} {{result=[[ [[1d20]]>@{Saving-2}+@{modquery} ]]}} {{check=[[@{Saving-2}+@{modquery}]]}}"
          data-i18n="magic-wands">
          Magic wands
        </button>
        <input type="number" name="attr_Saving-2" value="0" />
      </label>

      <label class="inline-flex inline-flex-wide-label">
        <button type="roll" name="attr_rollSaving-3"
          value="&{template:greater} {{roll=^{paralysis-petrification-full}}} {{result=[[ [[1d20]]>@{Saving-3}+@{modquery} ]]}} {{check=[[@{Saving-3}+@{modquery}]]}}"
          data-i18n="paralysis-petrification">
          Paralysis, Petrification
        </button>
        <input type="number" name="attr_Saving-3" value="0" />
      </label>

      <label class="inline-flex inline-flex-wide-label">
        <button type="roll" name="attr_rollSaving-4"
          value="&{template:greater} {{roll=^{breath-attacks-full}}} {{result=[[ [[1d20]]>@{Saving-4}+@{modquery} ]]}} {{check=[[@{Saving-4}+@{modquery}]]}}"
          data-i18n="breath-attacks">
          Breath attacks
        </button>
        <input type="number" name="attr_Saving-4" value="0" />
      </label>
      <label class="inline-flex inline-flex-wide-label">
        <button type="roll" name="attr_rollSaving-5"
          value="&{template:greater} {{roll=^{spells-rods-staves-full}}} {{result=[[ [[1d20]]>@{Saving-5}+@{modquery} ]]}} {{check=[[@{Saving-5}+@{modquery}]]}}"
          data-i18n="spells-rods-staves">
          Spells, Rods, Staves
        </button>
        <input type="number" name="attr_Saving-5" value="0" />
      </label>
    </div>
  </div>

  <div class="sheet-monster-notes">
    <h1 data-i18n="notes">Notes</h1>
    <textarea name="attr_monsterNotes"></textarea>
  </div>
</div>

<!-- Attack roll translation -->
<span style="display: none;" data-i18n="typeofattack">Type of attack</span>
<span style="display: none;" data-i18n="modifier">Threshold modifier</span>
<span style="display: none;" data-i18n="modifier-mod">Modif</span>
<span style="display: none;" data-i18n="attack">Attack</span>
<span style="display: none;" data-i18n="attack">Damage</span>

<!-- Other translation -->
<span style="display: none;" data-i18n="initiative">Initiative</span>
<span style="display: none;" data-i18n="strength">Strength</span>
<span style="display: none;" data-i18n="intelligence">Intelligence</span>
<span style="display: none;" data-i18n="wisdom">Wisdom</span>
<span style="display: none;" data-i18n="dexterity">Dexterity</span>
<span style="display: none;" data-i18n="constitution">Constitution</span>
<span style="display: none;" data-i18n="charisma">Charisma</span>
<span style="display: none;" data-i18n="morale">Morale</span>

<span style="display: none;" data-i18n="death-poison-full">Death or poison</span>
<span style="display: none;" data-i18n="magic-wands-full">Magic wands</span>
<span style="display: none;" data-i18n="paralysis-petrification-full">Paralysis or petrification</span>
<span style="display: none;" data-i18n="breath-attacks-full">Breath attacks</span>
<span style="display: none;" data-i18n="spells-rods-staves-full">Spells, rods or staves</span>
<span style="display: none;" data-i18n="listen-at-door-full">Listen at door</span>
<span style="display: none;" data-i18n="open-stuck-door-full">Open stuck door</span>
<span style="display: none;" data-i18n="find-secret-room-full">Find secret room</span>
<span style="display: none;" data-i18n="find-room-trap-full">Find room trap</span>

<rolltemplate class="sheet-rolltemplate-simple">
  <div>
    <h3>{{roll}}</h3>
    {{#result}}
    <span class="sheet-template-result-only">{{result}}</span>
    {{/result}}
    {{#allprops() roll result description morale}}
    <div class="sheet-template-row">
      <span class="sheet-template-term">{{key}}:</span>
      <span class="sheet-template-result">{{value}}</span>
    </div>
    {{/allprops() roll result description morale}}
    {{#description}}
    <div class="sheet-template-description">{{description}}</div>
    {{/description}}

    <!-- Morale Specific -->
    {{#rollGreater() morale 0}}
    <span class="sheet-template-result-only fullcrit" data-i18n="morale-continue-fighting">Continue Fighting!</span>
    {{/rollGreater() morale 0}}
    {{#rollLess() morale 1}}
    <span class="sheet-template-result-only fullfail" data-i18n="morale-surrender-or-flee">Surrender or Flee!</span>
    {{/rollLess() morale 1}}
  </div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-greater">
  <div>
    <h3>{{roll}}</h3>
    <span style="background: white; display: none;">{{check}}</span>
    <span style="background: white;">{{result}}</span>
    {{#rollLess() result check}}
    <span class="rollresult rollfail" data-i18n="fail">Fail</span>
    {{/rollLess() result check}}

    {{#rollGreater() result check}}
    <span class="rollresult rollsuccess" data-i18n="success">Success</span>
    {{/rollGreater() result check}}

    {{#rollTotal() result check}}
    <span class="rollresult rollsuccess" data-i18n="success">Success</span>
    {{/rollTotal() result check}}
  </div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-less">
  <div>
    <h3>{{roll}}</h3>
    <span style="background: white; display: none;">{{check}}</span>
    <span style="background: white;">{{result}}</span>

    {{#rollTotal() result check}}
    <span class="rollresult rollsuccess" data-i18n="success">Success</span>
    {{/rollTotal() result check}}

    {{#rollLess() result check}}
    <span class="rollresult rollsuccess" data-i18n="success">Success</span>
    {{/rollLess() result check}}

    {{#rollGreater() result check}}
    <span class="rollresult rollfail" data-i18n="fail">Fail</span>
    {{/rollGreater() result check}}
  </div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-skill">
  <div>
    <h3>{{roll}}</h3>
    <span style="background: white;">{{result}}</span>
    {{#rollTotal() symbol 2}}
    {{#rollLess() result check}}
    <span class="rollresult rollfail" data-i18n="fail">Fail</span>
    {{/rollLess() result check}}
    {{#rollGreater() result check}}
    <span class="rollresult rollsuccess" data-i18n="success">Success</span>
    {{/rollGreater() result check}}
    {{#rollTotal() result check}}
    <span class="rollresult rollsuccess" data-i18n="success">Success</span>
    {{/rollTotal() result check}}
    {{/rollTotal() symbol 2}}

    {{#rollTotal() symbol 1}}
    {{#rollTotal() result check}}
    <span class="rollresult rollsuccess" data-i18n="success">Success</span>
    {{/rollTotal() result check}}
    {{#rollLess() result check}}
    <span class="rollresult rollsuccess" data-i18n="success">Success</span>
    {{/rollLess() result check}}
    {{#rollGreater() result check}}
    <span class="rollresult rollfail" data-i18n="fail">Fail</span>
    {{/rollGreater() result check}}
    {{/rollTotal() symbol 1}}

    {{#description}}
    <div class="sheet-template-description">
      {{description}}
    </div>
    {{/description}}
  </div>
</rolltemplate>

<script type="text/worker">
  /* ===== PARAMETERS ==========
  destination = the name of the attribute that stores the total quantity
  section = name of repeating fieldset, without the repeating_
  fields = the name of the attribute field to be summed
      can be a single attribute: 'weight'
      or an array of attributes: ['weight','number','equipped']
  multiplier (optional) = a multiplier to the entire fieldset total. For instance, if summing coins of weight 0.02, might want to multiply the final total by 0.02.
  */
  const repeatingSum = (destination, section, fields, { multiplier = 1, callback = Function.prototype}) => {
    if (!Array.isArray(fields)) fields = [fields];
    getSectionIDs(`repeating_${section}`, idArray => {
        const attrArray = idArray.reduce( (m,id) => [...m, ...(fields.map(field => `repeating_${section}_${id}_${field}`))],[]);
        getAttrs(attrArray, v => {
            console.log("===== values of v: "+ JSON.stringify(v) +" =====");
                  // getValue: if not a number, returns 1 if it is 'on' (checkbox), otherwise returns 0..
            const getValue = (section, id,field) => parseFloat(v[`repeating_${section}_${id}_${field}`]) || (v[`repeating_${section}_${id}_${field}`] === 'on' ? 1 : 0);
            const sumTotal = idArray.reduce((total, id) => total + fields.reduce((subtotal,field) => subtotal * getValue(section, id,field),1),0);
            setAttrs({[destination]: sumTotal * multiplier}, callback);
        });
    });
  };

  on("sheet:opened", function(eventInfo){
      setAttrs({
          modquery: "?{" + getTranslationByKey("modifier") + "|0}[" + getTranslationByKey("modifier-mod") + "]",
          mod: "?{" + getTranslationByKey("modifier-mod") + "|0}[" + getTranslationByKey("modifier-mod") + "]"
      });

  });

  on("change:dex", function() {
     getAttrs(["ACDexMod", "InitDexMod", "BonusDEX", "dex"], function(values) {
        if (values.dex == 3) {
          setAttrs({
             ACDexMod: -3,
             BonusDEX: -3,
             InitDexMod: -2,
             acUnarmored: 10-3
          });
        };
        if (values.dex > 3 && values.dex <= 5 ) {
          setAttrs({
             ACDexMod: -2,
             BonusDEX: -2,
             InitDexMod: -1,
             acUnarmored: 10-2
          });
        };
        if (values.dex >= 6 && values.dex <= 8 ) {
          setAttrs({
             ACDexMod: -1,
             BonusDEX: -1,
             InitDexMod: -1,
             acUnarmored: 10-1
          });
        };
        if (values.dex >= 9 && values.dex <= 12 ) {
          setAttrs({
             ACDexMod: 0,
             BonusDEX: 0,
             InitDexMod: 0,
             acUnarmored: 10
          });
        };
        if (values.dex >= 13 && values.dex <= 15 ) {
          setAttrs({
             ACDexMod: 1,
             BonusDEX: 1,
             InitDexMod: 1,
             acUnarmored: 10+1
          });
        };
        if (values.dex >= 16 && values.dex <= 17 ) {
          setAttrs({
             ACDexMod: 2,
             BonusDEX: 2,
             InitDexMod: 1,
             acUnarmored: 10+2
          });
        };
        if (values.dex == 18 ) {
          setAttrs({
             ACDexMod: 3,
             BonusDEX: 3,
             InitDexMod: 2,
             acUnarmored: 10+3
          });
        };
     });
  });

  on("change:str", function() {
     getAttrs(["BonusSTR", "OpenDoor", "str"], function(values) {
        if (values.str == 3) {
          setAttrs({
             BonusSTR: -3,
             OpenDoor: 1
          });
        } else if (values.str > 3 && values.str <= 5 ) {
          setAttrs({
             BonusSTR: -2,
             OpenDoor: 1
          });
        } else if (values.str >= 6 && values.str <= 8 ) {
          setAttrs({
             BonusSTR: -1,
             OpenDoor: 1
          });
        } else if (values.str >= 9 && values.str <= 12 ) {
          setAttrs({
             BonusSTR: 0,
             OpenDoor: 2
          });
        } else if (values.str >= 13 && values.str <= 15 ) {
          setAttrs({
             BonusSTR: 1,
             OpenDoor: 3
          });
        } else if (values.str >= 16 && values.str <= 17 ) {
          setAttrs({
             BonusSTR: 2,
             OpenDoor: 4
          });
        } else if (values.str == 18 ) {
          setAttrs({
             BonusSTR: 3,
             OpenDoor: 5
          });
        };
     });
  });

  on("change:con", function() {
     getAttrs(["HPConMod", "con"], function(values) {
        if (values.con == 3) {
          setAttrs({
             HPConMod: -3
          });
        };
        if (values.con > 3 && values.con <= 5 ) {
          setAttrs({
             HPConMod: -2
          });
        };
        if (values.con >= 6 && values.con <= 8 ) {
          setAttrs({
             HPConMod: -1
          });
        };
        if (values.con >= 9 && values.con <= 12 ) {
          setAttrs({
             HPConMod: 0
          });
        };
        if (values.con >= 13 && values.con <= 15 ) {
          setAttrs({
             HPConMod: 1
          });
        };
        if (values.con >= 16 && values.con <= 17 ) {
          setAttrs({
             HPConMod: 2
          });
        };
        if (values.con == 18 ) {
          setAttrs({
             HPConMod: 3
          });
        };
     });
  });

  on("change:level", function() {
    getAttrs(["level", "hitdice"], function(values) {
      setAttrs({ hitdice: Math.min(9, values.level) });
    });
  });

  on('sheet:opened change:repeating_armor remove:repeating_armor', function() {
    repeatingSum(
      "ArmorBenefitTotal",
      "armor",
      ["armorBenefit", "armorWorn"],
      {
        callback: function () {
          getAttrs(["ArmorBenefitTotal", "acUnarmored"], function(values) {
            setAttrs({
              ac: Object.values(values).reduce((sum, cur) => sum + cur)
            });
          });
        }
      }
    );
  });

  on('clicked:setAverageHP', function() {
    getAttrs(['monsterHitDice', 'monsterHitDiceModifier'], function(values) {
      const averageHP = Math.floor(
        (parseInt(values.monsterHitDice, 10) * 4.5) + parseInt(values.monsterHitDiceModifier, 10)
      );
      setAttrs({
        HP: averageHP,
        HP_max: averageHP
      });
    });
  });

  // Recalculate encumbrance
  on([
    "sheet:opened",
    "change:repeating_armor",
    "remove:repeating_armor",
    "change:repeating_items",
    "remove:repeating_items",
    "change:repeating_weapons",
    "remove:repeating_weapons",
    "change:PP",
    "change:EP",
    "change:GP",
    "change:SP",
    "change:CP"
  ].join(' '), function() {
    repeatingSum("ArmorWeightTotal", "armor", "armorWeight", { callback: () => {
      repeatingSum("ItemWeightTotal", "items", "ItemWeight", { callback: () => {
        repeatingSum("WeaponWeightTotal", "weapons", "weaponWeight", { callback: () => {
          getAttrs(['PP', 'EP', 'GP', 'SP', 'CP', 'ArmorWeightTotal', 'WeaponWeightTotal', 'ItemWeightTotal'], (weights) => {
            setAttrs({
              Encumbrance: Object.values(weights)
                .map(weight => parseInt(weight, 10))
                .reduce((sum, cur) => sum + cur)
            })
          })
        }});
      }});
    }});
  })

  // Tabs
  const buttonlist = ["character", "monster"];
    buttonlist.forEach(button => {
      on(`clicked:${button}`, function(event) {
        setAttrs({ sheetTab: button });
      });
    });
</script>
